Imports CommonDB
Imports DevExpress.XtraEditors
Imports PublicUtility
Public Class FrmOutTrayAndU00_2
    Dim _db As New DBSql(PublicConst.EnumServers.NDV_SQL_ERP_NDV)
    Dim orderDate As String
    Dim isEdit As Boolean = True

    Dim EcodeOld As String
    Dim PdCodeOld As String
    Dim JCodeOld As String
    Dim SubPrcNameOld As String
    Private Sub FrmOutTrayAndU00_2_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        Dim obj As New Main_UserRight
        obj.FormID_K = Tag
        obj.UserID_K = CurrentUser.UserID
        _db.GetObject(obj)
        If Not obj.IsEdit Then
            ViewAccess()
            isEdit = False
        End If
        dteOrderDate.DateTime = DateTime.Now
    End Sub

    Private Sub dteOrderDate_EditValueChanged(sender As Object, e As EventArgs) Handles dteOrderDate.EditValueChanged
        orderDate = dteOrderDate.DateTime.ToString("yyyyMMdd")
    End Sub
    Sub ViewAccess()
        chbLockedTime1.ReadOnly = True
        chbLockedTime2.ReadOnly = True
    End Sub

    Private Sub btnShow_ItemClick(sender As Object, e As DevExpress.XtraBars.ItemClickEventArgs) Handles btnShow.ItemClick
        Dim objlock As New PCM_LockDay
        objlock.YMD_K = orderDate
        If _db.ExistObject(objlock) Then
            _db.GetObject(objlock)
        Else
            objlock.JCodeLocked1 = True
            objlock.JCodeLocked2 = True
            objlock.JCodeLocked3 = True
            objlock.TrayLocked1 = True
            objlock.TrayLocked2 = True
            objlock.DirectLocked = True
            objlock.OutWSLocked = True
            _db.Insert(objlock)
        End If

        chbLockedTime1.Checked = objlock.TrayLocked1
        chbLockedTime2.Checked = objlock.TrayLocked2

        Dim day As String = orderDate
        Dim M1 As DateTime = New DateTime(DateTime.Now.AddMonths(-1).Year, DateTime.Now.AddMonths(-1).Month, DateTime.Now.AddMonths(-1).Day)
        Dim M3 As DateTime = New DateTime(DateTime.Now.AddMonths(-3).Year, DateTime.Now.AddMonths(-3).Month, DateTime.Now.AddMonths(-3).Day)

        Dim para(4) As SqlClient.SqlParameter
        para(0) = New SqlClient.SqlParameter("@M1", M1.ToString("yyyyMM"))
        para(1) = New SqlClient.SqlParameter("@M3", M3.ToString("yyyyMM"))
        para(2) = New SqlClient.SqlParameter("@day", day)
        para(3) = New SqlClient.SqlParameter("@Action", "ShowNew")
        If isEdit Then
            para(4) = New SqlClient.SqlParameter("@ECode", DBNull.Value)
        Else
            para(4) = New SqlClient.SqlParameter("@ECode", CurrentUser.UserID)
        End If

        GridControl1.DataSource = _db.ExecuteStoreProcedureTB("[sp_PCM_OutTrayAndU00_PR]", para)
        GridControlSetFormat(GridView1, 4)
        'GridView1.Columns("DeptName").Visible = False
        'GridView1.Columns("YMD").Visible = False

        Dim dtJCode As DataTable = _db.FillDataTable("SELECT ECode, PdCode, JCode, JVName, JEName, 
                                                      SubPrcName, PrcName, Unit
                                                      FROM PCM_MterTrayU00
                                                      WHERE (@ECode IS NULL OR ECode = @ECode)", para)
        slueJCode.DataSource = dtJCode
        slueJCode.DisplayMember = "JCode"
        slueJCode.ValueMember = "JCode"
        slueJCode.NullText = Nothing
        GridView1.Columns("JCode").ColumnEdit = slueJCode
    End Sub
    Sub ColReadOnly()
        GridControlReadOnly(GridView1, False)
        GridView1.Columns("YMD").OptionsColumn.ReadOnly = True
        GridView1.Columns("DeptName").OptionsColumn.ReadOnly = True
        GridView1.Columns("ECode").OptionsColumn.ReadOnly = True
        GridView1.Columns("PdCode").OptionsColumn.ReadOnly = True
        GridView1.Columns("JVName").OptionsColumn.ReadOnly = True
        GridView1.Columns("JEName").OptionsColumn.ReadOnly = True
        GridView1.Columns("SubPrcName").OptionsColumn.ReadOnly = True
        GridView1.Columns("PrcName").OptionsColumn.ReadOnly = True
        GridView1.Columns("Unit").OptionsColumn.ReadOnly = True
        GridView1.Columns("TotalQty").OptionsColumn.ReadOnly = True
        GridView1.Columns("AVGUsing").OptionsColumn.ReadOnly = True
        GridView1.Columns("Total0131").OptionsColumn.ReadOnly = True
        GridView1.Columns("Time1Date").OptionsColumn.ReadOnly = True
        GridView1.Columns("Time2Date").OptionsColumn.ReadOnly = True

        If chbLockedTime1.Checked Then
            GridView1.Columns("LotS1").OptionsColumn.ReadOnly = True
            GridView1.Columns("LotE1").OptionsColumn.ReadOnly = True
            GridView1.Columns("Bal1").OptionsColumn.ReadOnly = True
            GridView1.Columns("MatQty1").OptionsColumn.ReadOnly = True
        ElseIf chbLockedTime2.Checked Then
            GridView1.Columns("LotS2").OptionsColumn.ReadOnly = True
            GridView1.Columns("LotE2").OptionsColumn.ReadOnly = True
            GridView1.Columns("Bal2").OptionsColumn.ReadOnly = True
            GridView1.Columns("MatQty2").OptionsColumn.ReadOnly = True
        End If
        GridControlSetColorEdit(GridView1)
    End Sub

    Private Sub btnNew_ItemClick(sender As Object, e As DevExpress.XtraBars.ItemClickEventArgs) Handles btnNew.ItemClick
        btnShow.PerformClick()
        If Not chbLockedTime1.Checked Or Not chbLockedTime2.Checked Then
            GridView1.OptionsView.NewItemRowPosition = DevExpress.XtraGrid.Views.Grid.NewItemRowPosition.Top
            ColReadOnly()
        Else
            ShowWarning("Locked !")
        End If
    End Sub

    Private Sub btnEdit_ItemClick(sender As Object, e As DevExpress.XtraBars.ItemClickEventArgs) Handles btnEdit.ItemClick
        If Not chbLockedTime1.Checked Or Not chbLockedTime2.Checked Then
            GridView1.OptionsView.NewItemRowPosition = DevExpress.XtraGrid.Views.Grid.NewItemRowPosition.None
            GridControlSetColorReadonly(GridView1)
            ColReadOnly()
        Else
            ShowWarning("Locked !")
        End If
    End Sub

    Private Sub GridView1_CellValueChanged(sender As Object, e As DevExpress.XtraGrid.Views.Base.CellValueChangedEventArgs) Handles GridView1.CellValueChanged
        If GridView1.Editable And Not e.Column.ReadOnly Then
            If IsDBNull(GridView1.GetFocusedRowCellValue("JCode")) Then
                ShowWarning("Bạn phải nhập JCode trước !")
                btnNew.PerformClick()
                Return
            End If
            If e.Column.FieldName = "JCode" And Not IsDBNull(GridView1.GetFocusedRowCellValue("YMD")) Then
                'sửa JCode
                _db.ExecuteNonQuery(String.Format("UPDATE PCM_TrayU00
                                                   SET ECode = '{0}', 
                                                   PdCode = '{1}', 
                                                   JCode = '{2}', 
                                                   SubPrcName = '{3}'
                                                   WHERE YMD = '{4}'
                                                   AND ECode = '{5}'
                                                   AND PdCode = '{6}'
                                                   AND JCode = '{7}'
                                                   AND SubPrcName = '{8}'",
                                                   GridView1.GetFocusedRowCellValue("ECode"),
                                                   GridView1.GetFocusedRowCellValue("PdCode"),
                                                   GridView1.GetFocusedRowCellValue("JCode"),
                                                   GridView1.GetFocusedRowCellValue("SubPrcName"),
                                                   GridView1.GetFocusedRowCellValue("YMD"),
                                                   EcodeOld, PdCodeOld, JCodeOld, SubPrcNameOld))
                Return
            End If
            If e.RowHandle < 0 Then
                If IsDBNull(GridView1.GetFocusedRowCellValue("YMD")) Then
                    Dim obj As New PCM_TrayU00
                    obj.YMD_K = orderDate
                    obj.ECode_K = GridView1.GetFocusedRowCellValue("ECode")
                    obj.PdCode_K = GridView1.GetFocusedRowCellValue("PdCode")
                    obj.JCode_K = GridView1.GetFocusedRowCellValue("JCode")
                    obj.SubPrcName_K = GridView1.GetFocusedRowCellValue("SubPrcName")
                    If _db.ExistObject(obj) Then
                        ShowWarning("JCode đã được tạo trong hôm nay, bạn không thể tạo lần 2 !")
                        Return
                    Else
                        Dim objD As New PCM_Dept
                        objD.ECode_K = GridView1.GetFocusedRowCellValue("ECode")
                        objD.SubPrcName_K = GridView1.GetFocusedRowCellValue("SubPrcName")
                        _db.GetObject(objD)
                        Dim dept As Object = objD.DeptName
                        obj.DeptName = IIf(IsDBNull(dept), "", dept)
                        obj.JVName = GridView1.GetFocusedRowCellValue("JVName")
                        obj.JEName = GridView1.GetFocusedRowCellValue("JEName")
                        obj.PrcName = GridView1.GetFocusedRowCellValue("PrcName")
                        obj.Unit = GridView1.GetFocusedRowCellValue("Unit")
                        obj.CreateUser = CurrentUser.UserID
                        obj.CreateDate = DateTime.Now
                        _db.Insert(obj)
                        GridView1.SetFocusedRowCellValue("YMD", obj.YMD_K)
                        GridView1.SetFocusedRowCellValue("DeptName", obj.DeptName)
                    End If
                End If
            End If


            Dim para(0) As SqlClient.SqlParameter
            para(0) = New SqlClient.SqlParameter("@Value", e.Value)
            _db.ExecuteNonQuery(String.Format("UPDATE PCM_TrayU00
                                               SET {0} = @Value,
                                               UpdateUser = '{1}',
                                               UpdateDate = '{2}'
                                               WHERE YMD = '{3}'
                                               AND ECode = '{4}'
                                               AND PdCode = '{5}'
                                               AND JCode = '{6}'
                                               AND SubPrcName = '{7}'",
                                               e.Column.FieldName,
                                               CurrentUser.UserID,
                                               DateTime.Now,
                                               GridView1.GetFocusedRowCellValue("YMD"),
                                               GridView1.GetFocusedRowCellValue("ECode"),
                                               GridView1.GetFocusedRowCellValue("PdCode"),
                                               GridView1.GetFocusedRowCellValue("JCode"),
                                               GridView1.GetFocusedRowCellValue("SubPrcName")), para)
            If e.Column.FieldName = "LotS1" Or e.Column.FieldName = "LotE1" Or
                e.Column.FieldName = "Bal1" Or e.Column.FieldName = "MatQty1" Then
                UpdateTime("Time1Date")
            ElseIf e.Column.FieldName = "LotS2" Or e.Column.FieldName = "LotE2" Or
                e.Column.FieldName = "Bal2" Or e.Column.FieldName = "MatQty2" Then
                UpdateTime("Time2Date")
            End If
        End If
    End Sub
    Sub UpdateTime(col As String)
        Dim objTime1 As New PCM_TrayU00
        objTime1.YMD_K = GridView1.GetFocusedRowCellValue("YMD")
        objTime1.ECode_K = GridView1.GetFocusedRowCellValue("ECode")
        objTime1.PdCode_K = GridView1.GetFocusedRowCellValue("PdCode")
        objTime1.JCode_K = GridView1.GetFocusedRowCellValue("JCode")
        objTime1.SubPrcName_K = GridView1.GetFocusedRowCellValue("SubPrcName")
        _db.GetObject(objTime1)
        If col = "Time1Date" Then
            objTime1.Time1Date = DateTime.Now
        ElseIf col = "Time2Date" Then
            objTime1.Time2Date = DateTime.Now
        End If
        _db.Update(objTime1)
    End Sub

    Private Sub slueJCode_EditValueChanged(sender As Object, e As EventArgs) Handles slueJCode.EditValueChanged
        Dim lc As SearchLookUpEdit = CType(sender, SearchLookUpEdit)
        GridView1.SetFocusedRowCellValue("ECode", lc.Properties.View.GetFocusedRowCellValue("ECode"))
        GridView1.SetFocusedRowCellValue("PdCode", lc.Properties.View.GetFocusedRowCellValue("PdCode"))
        GridView1.SetFocusedRowCellValue("JVName", lc.Properties.View.GetFocusedRowCellValue("JVName"))
        GridView1.SetFocusedRowCellValue("JEName", lc.Properties.View.GetFocusedRowCellValue("JEName"))
        GridView1.SetFocusedRowCellValue("SubPrcName", lc.Properties.View.GetFocusedRowCellValue("SubPrcName"))
        GridView1.SetFocusedRowCellValue("PrcName", lc.Properties.View.GetFocusedRowCellValue("PrcName"))
        GridView1.SetFocusedRowCellValue("Unit", lc.Properties.View.GetFocusedRowCellValue("Unit"))
    End Sub

    Private Sub btnDelete_ItemClick(sender As Object, e As DevExpress.XtraBars.ItemClickEventArgs) Handles btnDelete.ItemClick
        If Not chbLockedTime1.Checked Or Not chbLockedTime2.Checked Then
            If ShowQuestion("Bạn có chắc chắn muốn xóa dữ liệu ?") = Windows.Forms.DialogResult.Yes Then
                _db.ExecuteNonQuery(String.Format("DELETE PCM_TrayU00
                                               WHERE YMD = '{0}'
                                               AND ECode = '{1}'
                                               AND PdCode = '{2}'
                                               AND JCode = '{3}'
                                               AND SubPrcName = '{4}'",
                                               GridView1.GetFocusedRowCellValue("YMD"),
                                               GridView1.GetFocusedRowCellValue("ECode"),
                                               GridView1.GetFocusedRowCellValue("PdCode"),
                                               GridView1.GetFocusedRowCellValue("JCode"),
                                               GridView1.GetFocusedRowCellValue("SubPrcName")))
                GridView1.DeleteSelectedRows()
            End If
        Else
            ShowWarning("Locked !")
        End If
    End Sub

    Private Sub slueJCode_BeforePopup(sender As Object, e As EventArgs) Handles slueJCode.BeforePopup
        EcodeOld = GridView1.GetFocusedRowCellValue("ECode")
        PdCodeOld = GridView1.GetFocusedRowCellValue("PdCode")
        JCodeOld = GridView1.GetFocusedRowCellValue("JCode")
        SubPrcNameOld = GridView1.GetFocusedRowCellValue("SubPrcName")
    End Sub

    Private Sub chbLockedTime1_CheckedChanged(sender As Object, e As EventArgs) Handles chbLockedTime1.CheckedChanged
        Dim obj As New PCM_LockDay
        obj.YMD_K = orderDate
        If _db.ExistObject(obj) Then
            _db.GetObject(obj)
            If chbLockedTime1.Checked Then
                obj.TrayLocked1 = True
            Else
                obj.TrayLocked1 = False
            End If
            _db.Update(obj)
        Else
            obj.JCodeLocked1 = True
            obj.JCodeLocked2 = True
            obj.JCodeLocked3 = True
            If chbLockedTime1.Checked Then
                obj.TrayLocked1 = True
            Else
                obj.TrayLocked1 = False
            End If
            obj.TrayLocked2 = True
            obj.DirectLocked = True
            obj.OutWSLocked = True
            _db.Insert(obj)
        End If
    End Sub

    Private Sub chbLockedTime2_CheckedChanged(sender As Object, e As EventArgs) Handles chbLockedTime2.CheckedChanged
        Dim obj As New PCM_LockDay
        obj.YMD_K = orderDate
        If _db.ExistObject(obj) Then
            _db.GetObject(obj)
            If chbLockedTime2.Checked Then
                obj.TrayLocked2 = True
            Else
                obj.TrayLocked2 = False
            End If
            _db.Update(obj)
        Else
            obj.JCodeLocked1 = True
            obj.JCodeLocked2 = True
            obj.JCodeLocked3 = True
            obj.TrayLocked1 = True
            If chbLockedTime2.Checked Then
                obj.TrayLocked2 = True
            Else
                obj.TrayLocked2 = False
            End If
            obj.DirectLocked = True
            obj.OutWSLocked = True
            _db.Insert(obj)
        End If
    End Sub

    Private Sub btnExport_ItemClick(sender As Object, e As DevExpress.XtraBars.ItemClickEventArgs) Handles btnExport.ItemClick
        GridControlExportExcel(GridView1)
    End Sub

    Private Sub btnCheckLot_ItemClick(sender As Object, e As DevExpress.XtraBars.ItemClickEventArgs) Handles btnCheckLot.ItemClick
        If GridView1.GetFocusedRowCellValue("JCode") IsNot Nothing Then
            FrmCheckLotOld._ECode = GridView1.GetFocusedRowCellValue("ECode")
            FrmCheckLotOld._JCode = GridView1.GetFocusedRowCellValue("JCode")
            FrmCheckLotOld._PdCode = GridView1.GetFocusedRowCellValue("PdCode")
            FrmCheckLotOld._SubPrcName = GridView1.GetFocusedRowCellValue("SubPrcName")
        End If
        Dim frm As New FrmCheckLotOld()
        frm.Show()
    End Sub
End Class